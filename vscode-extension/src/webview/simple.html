<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'none';
    style-src ${cspSource} 'unsafe-inline';
    script-src 'nonce-${nonce}';
  ">
  <title>Konsol</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--vscode-foreground);
      background: var(--vscode-panel-background);
      font-family: var(--vscode-editor-font-family), monospace;
      font-size: var(--vscode-editor-font-size);
    }

    .output {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
    }

    .output-line {
      margin: 4px 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: var(--vscode-editor-font-family), monospace;
    }

    .output-prompt { color: var(--vscode-terminal-ansiGreen); }
    .output-result { color: var(--vscode-terminal-ansiBrightBlue); }
    .output-error { color: var(--vscode-terminal-ansiRed); }
    .output-stdout { color: var(--vscode-terminal-foreground); }
    .output-stderr { color: var(--vscode-terminal-ansiYellow); }

    .status-bar {
      padding: 4px 12px;
      background: var(--vscode-statusBar-background);
      color: var(--vscode-statusBar-foreground);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--vscode-terminal-ansiRed);
    }

    .status-indicator.connected {
      background: var(--vscode-terminal-ansiGreen);
    }

    .input-wrapper {
      display: flex;
      gap: 8px;
      padding: 8px;
      border-top: 1px solid var(--vscode-panel-border);
      background: var(--vscode-input-background);
    }

    textarea {
      flex: 1;
      resize: none;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-family: var(--vscode-editor-font-family), monospace;
      font-size: var(--vscode-editor-font-size);
      padding: 8px;
      min-height: 60px;
    }

    textarea:focus {
      outline: 1px solid var(--vscode-focusBorder);
    }

    button {
      padding: 8px 16px;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      cursor: pointer;
      font-family: var(--vscode-font-family);
    }

    button:hover {
      background: var(--vscode-button-hoverBackground);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .welcome {
      padding: 16px;
      text-align: center;
      color: var(--vscode-descriptionForeground);
    }

    .welcome h3 {
      margin: 0 0 8px 0;
      color: var(--vscode-foreground);
    }

    .welcome code {
      font-family: var(--vscode-editor-font-family);
      background: var(--vscode-textBlockQuote-background);
      padding: 2px 4px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="output" id="output">
    <div class="welcome">
      <h3>Konsol - Rails Console</h3>
      <p>Press <code>Ctrl/Cmd+Enter</code> to run, <code>↑/↓</code> for history</p>
    </div>
  </div>
  <div class="status-bar">
    <div class="status-indicator" id="status-indicator"></div>
    <span id="status-text">Disconnected</span>
  </div>
  <div class="input-wrapper">
    <textarea id="input" placeholder="Enter Ruby code..." rows="3"></textarea>
    <button id="run-btn" disabled>Run</button>
  </div>

  <script nonce="${nonce}">
    const vscode = acquireVsCodeApi()
    const output = document.getElementById("output")
    const input = document.getElementById("input")
    const runBtn = document.getElementById("run-btn")
    const statusIndicator = document.getElementById("status-indicator")
    const statusText = document.getElementById("status-text")

    let connected = false
    let evaluating = false
    const commandHistory = []
    let historyIndex = -1
    let welcomeCleared = false

    function clearWelcome() {
      if (!welcomeCleared) {
        const welcome = output.querySelector(".welcome")
        if (welcome) {
          welcome.remove()
        }
        welcomeCleared = true
      }
    }

    function appendOutput(text, className) {
      clearWelcome()
      const line = document.createElement("div")
      line.className = "output-line " + className
      line.textContent = text
      output.appendChild(line)
      output.scrollTop = output.scrollHeight
    }

    function updateUI() {
      runBtn.disabled = !connected || evaluating || !input.value.trim()
      runBtn.textContent = evaluating ? "Running..." : "Run"
      statusIndicator.className = "status-indicator" + (connected ? " connected" : "")
    }

    function handleEval() {
      const code = input.value.trim()
      if (!code || evaluating || !connected) return

      commandHistory.push(code)
      historyIndex = -1
      appendOutput("> " + code, "output-prompt")
      evaluating = true
      updateUI()
      vscode.postMessage({ type: "eval", code })
      input.value = ""
    }

    runBtn.addEventListener("click", handleEval)

    input.addEventListener("input", updateUI)

    input.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
        event.preventDefault()
        handleEval()
      }
      if (event.key === "ArrowUp" && commandHistory.length > 0) {
        event.preventDefault()
        if (historyIndex === -1) {
          historyIndex = commandHistory.length
        }
        historyIndex = Math.max(0, historyIndex - 1)
        input.value = commandHistory[historyIndex]
        updateUI()
      }
      if (event.key === "ArrowDown" && historyIndex !== -1) {
        event.preventDefault()
        historyIndex = Math.min(commandHistory.length - 1, historyIndex + 1)
        input.value = commandHistory[historyIndex]
        updateUI()
      }
    })

    window.addEventListener("message", (event) => {
      const message = event.data
      switch (message.type) {
        case "connected":
          connected = true
          statusText.textContent = "Connected (session: " + message.sessionId.substring(0, 8) + "...)"
          updateUI()
          input.focus()
          break

        case "disconnected":
          connected = false
          statusText.textContent = message.reason || "Disconnected"
          updateUI()
          break

        case "result":
          evaluating = false
          updateUI()
          const data = message.data
          if (data.stdout) {
            appendOutput(data.stdout, "output-stdout")
          }
          if (data.stderr) {
            appendOutput(data.stderr, "output-stderr")
          }
          if (data.exception) {
            appendOutput(data.exception.class + ": " + data.exception.message, "output-error")
            data.exception.backtrace.slice(0, 5).forEach(function(line) {
              appendOutput("  " + line, "output-error")
            })
          } else {
            const display = data.valueType
              ? "=> " + data.value + " (" + data.valueType + ")"
              : "=> " + data.value
            appendOutput(display, "output-result")
          }
          input.focus()
          break

        case "error":
          evaluating = false
          updateUI()
          appendOutput("Error: " + message.message, "output-error")
          input.focus()
          break

        case "notification":
          if (message.method === "konsol/stdout" && message.params.chunk) {
            appendOutput(message.params.chunk, "output-stdout")
          } else if (message.method === "konsol/stderr" && message.params.chunk) {
            appendOutput(message.params.chunk, "output-stderr")
          } else if (message.method === "konsol/status") {
            evaluating = message.params.busy
            updateUI()
          }
          break

        case "clear":
          output.innerHTML = ""
          welcomeCleared = false
          break
      }
    })

    vscode.postMessage({ type: "ready" })
    input.focus()
  </script>
</body>
</html>
